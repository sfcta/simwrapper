var e=Object.defineProperty,t=Object.defineProperties,s=Object.getOwnPropertyDescriptors,a=Object.getOwnPropertySymbols,n=Object.prototype.hasOwnProperty,i=Object.prototype.propertyIsEnumerable,r=(t,s,a)=>s in t?e(t,s,{enumerable:!0,configurable:!0,writable:!0,value:a}):t[s]=a;import{G as o}from"./index.84f8ccb6.js";import{v as c,f as l,I as p}from"./icon-manager.2c4c9b5c.js";import{a as g,b as u,c as d,M as h,G as m,l as f}from"./layer.b20bd88e.js";function y(){return new Worker("/simwrapper/assets/MATSimEventStreamer.worker.853965d0.js",{type:"module"})}const b=[0,0,0,255],v={iconAtlas:{type:"image",value:null,async:!0},iconMapping:{type:"object",value:{},async:!0},sizeScale:{type:"number",value:1,min:0},billboard:!1,sizeUnits:"pixels",sizeMinPixels:{type:"number",min:0,value:0},sizeMaxPixels:{type:"number",min:0,value:Number.MAX_SAFE_INTEGER},alphaCutoff:{type:"number",value:.05,min:0,max:1},iconStill:{type:"object",value:null},getIcon:{type:"accessor",value:"vehicle"},getBOffsets:{type:"accessor",value:[0,0]},getBIconFrames:{type:"accessor",value:[128,128,128,128]},getBColorModes:{type:"accessor",value:1},getColor:{type:"accessor",value:b},getSize:{type:"accessor",value:1},getAngle:{type:"accessor",value:0},getPixelOffset:{type:"accessor",value:[0,0]},getPathStart:{type:"accessor",value:null},getPathEnd:{type:"accessor",value:null},getTimeStart:{type:"accessor",value:null},getTimeEnd:{type:"accessor",value:null},currentTime:{type:"number",value:0},pickable:{type:"boolean",value:!0},onIconError:{type:"function",value:null,compare:!1,optional:!0}};class M extends g{getShaders(){return super.getShaders({vs:c,fs:l,modules:[u,d]})}initializeState(){this.state={iconManager:new p(this.context.gl,{onUpdate:this._onUpdate.bind(this),onError:this._onError.bind(this)})};this.getAttributeManager().addInstanced({instanceTimestamps:{size:1,accessor:"getTimeStart"},instanceTimestampsNext:{size:1,accessor:"getTimeEnd"},instanceStartPositions:{size:2,accessor:"getPathStart"},instanceEndPositions:{size:2,accessor:"getPathEnd"},instanceSizes:{size:1,transition:!0,accessor:"getSize",defaultValue:1},instanceOffsets:{size:2,defaultValue:[0,0],accessor:"getBOffsets"},instanceIconFrames:{size:4,defaultValue:[0,0,128,128],accessor:"getBIconFrames"},instanceColorModes:{size:1,type:o.UNSIGNED_BYTE,defaultValue:1,accessor:"getBColorModes"},instanceColors:{size:this.props.colorFormat.length,type:o.UNSIGNED_BYTE,normalized:!0,transition:!0,accessor:"getColor",defaultValue:b},instanceAngles:{size:1,transition:!0,accessor:"getAngle"},instancePixelOffset:{size:2,transition:!0,accessor:"getPixelOffset"}})}updateState({oldProps:e,props:t,changeFlags:s}){var a;super.updateState({props:t,oldProps:e,changeFlags:s});const n=this.getAttributeManager(),{iconAtlas:i,iconMapping:r,data:o,getIcon:c}=t,{iconManager:l}=this.state;l.setProps({loadOptions:t.loadOptions});let p=!1;if(i||this.internalState.isAsyncPropLoading("iconAtlas")?(e.iconAtlas!==t.iconAtlas&&l.setProps({iconAtlas:i,autoPacking:!1}),e.iconMapping!==t.iconMapping&&(l.setProps({iconMapping:r}),p=!0)):l.setProps({autoPacking:!0}),(s.dataChanged||s.updateTriggersChanged&&(s.updateTriggersChanged.all||s.updateTriggersChanged.getIcon))&&l.setProps({data:o,getIcon:c}),p&&(n.invalidate("instanceOffsets"),n.invalidate("instanceIconFrames"),n.invalidate("instanceColorModes")),s.extensionsChanged){const{gl:e}=this.context;null==(a=this.state.model)||a.delete(),this.state.model=this._getModel(e),n.invalidateAll()}}get isLoaded(){return super.isLoaded&&this.state.iconManager.isLoaded}finalizeState(){super.finalizeState(),this.state.iconManager.finalize()}draw({uniforms:e}){const{sizeScale:t,sizeMinPixels:s,sizeMaxPixels:a,sizeUnits:n,billboard:i,alphaCutoff:r,currentTime:o,iconStill:c,pickable:l}=this.props,{iconManager:p}=this.state,{viewport:g}=this.context,u=p.getTexture();u&&this.state.model.setUniforms(e).setUniforms({iconsTexture:u,iconsTextureDim:[u.width,u.height],sizeScale:t*("pixels"===n?g.metersPerPixel:1),sizeMinPixels:s,sizeMaxPixels:a,billboard:i,alphaCutoff:r,currentTime:o,pickable:l,iconStillOffsets:this.getInstanceOffset(c),iconStillFrames:this.getInstanceIconFrame(c)}).draw()}_getModel(e){return new h(e,(c=((e,t)=>{for(var s in t||(t={}))n.call(t,s)&&r(e,s,t[s]);if(a)for(var s of a(t))i.call(t,s)&&r(e,s,t[s]);return e})({},this.getShaders()),l={id:this.props.id,geometry:new m({drawMode:o.TRIANGLE_FAN,attributes:{positions:{size:2,value:new Float32Array([-1,-1,-1,1,1,1,1,-1])}}}),isInstanced:!0},t(c,s(l))));var c,l}_onUpdate(){this.setNeedsRedraw()}_onError(e){const{onIconError:t}=this.getCurrentLayer().props;t?t(e):f.error(e.error)()}getInstanceOffset(e){const t=this.state.iconManager.getIconMapping(e);return[t.width/2-t.anchorX||0,t.height/2-t.anchorY||0]}getInstanceColorMode(e){return this.state.iconManager.getIconMapping(e).mask?1:0}getInstanceIconFrame(e){const t=this.state.iconManager.getIconMapping(e);return[t.x||0,t.y||0,t.width||0,t.height||0]}}M.layerName="FlatIconLayer",M.defaultProps=v;export{M as I,y as W};
//# sourceMappingURL=moving-icons-vehicles-layer.02757695.js.map
