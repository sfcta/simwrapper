{"version":3,"file":"TopSheet.2244b18e.js","sources":["../../src/components/TopSheet/TopSheet.vue","../../src/components/TopSheet/TopSheet.vue?vue&type=template&lang.js"],"sourcesContent":["<template lang=\"pug\">\r\n.topsheet.curate-content\r\n  h3.curate-heading(v-if=\"title\")  {{ title }}\r\n\r\n  .output-table(v-if=\"entries.length\")\r\n    .row(v-for=\"row,i in entries\" :key=\"'entry'+i\")\r\n      .cell.top-label(:style=\"row.style\") {{ row.title }}\r\n      b-input.b-input-tight.cell.top-value(\r\n        v-model=\"row.value\"\r\n        :style=\"row.style\"\r\n        @input=\"boxChanged\"\r\n      )\r\n\r\n  .output-table(v-if=\"table.length\" style=\"margin-top: 1rem\")\r\n    .row(v-for=\"row,i in table\" :key=\"'row'+i\")\r\n      .cell.top-label(:style=\"row.style\") {{ row.title }}\r\n      .cell.top-value(:style=\"row.style\") {{ formattedValue(row.value) }}\r\n\r\n</template>\r\n\r\n<script lang=\"ts\">\r\nimport { defineComponent } from 'vue'\r\nimport type { PropType } from 'vue'\r\n\r\nimport { FileSystemConfig, YamlConfigs } from '@/Globals'\r\n\r\nimport TopSheetWorker from './TopSheetWorker.worker.ts?worker'\r\nimport globalStore from '@/store'\r\n\r\nexport type TableRow = {\r\n  title: string\r\n  value: any\r\n  style?: any\r\n}\r\n\r\nexport default defineComponent({\r\n  name: 'TopSheet',\r\n  props: {\r\n    fileSystemConfig: { type: Object as PropType<FileSystemConfig>, required: true },\r\n    subfolder: { type: String, required: true },\r\n    files: { type: Array as PropType<string[]>, required: true },\r\n    yaml: { type: String, required: true },\r\n    allConfigFiles: { type: Object as PropType<YamlConfigs>, required: true },\r\n    cardId: String,\r\n  },\r\n  data: () => {\r\n    return {\r\n      globalState: globalStore.state,\r\n      solverThread: null as any,\r\n      table: [] as TableRow[],\r\n      entries: [] as { key: string; title: string; value: any }[],\r\n      title: '',\r\n    }\r\n  },\r\n  mounted() {\r\n    if (this.files.length) this.runTopSheet()\r\n  },\r\n\r\n  beforeDestroy() {\r\n    try {\r\n      if (this.solverThread) {\r\n        this.solverThread.terminate()\r\n        this.solverThread = null\r\n      }\r\n    } catch (e) {\r\n      console.warn(e)\r\n    }\r\n  },\r\n  watch: {\r\n    'globalState.locale'() {\r\n      if (this.solverThread) {\r\n        this.solverThread.postMessage({\r\n          command: 'updateCalculations',\r\n          entries: this.entries,\r\n          locale: this.globalState.locale,\r\n        })\r\n      }\r\n    },\r\n  },\r\n  methods: {\r\n    formattedValue(value: any) {\r\n      if (!isNaN(value)) return value.toLocaleString([this.$store.state.locale, 'en'])\r\n      if (value === undefined) return '-?-'\r\n      return value\r\n    },\r\n\r\n    async boxChanged() {\r\n      console.log('changed!')\r\n      if (this.solverThread) {\r\n        this.solverThread.postMessage({\r\n          command: 'updateCalculations',\r\n          entries: this.entries,\r\n          locale: this.globalState.locale,\r\n        })\r\n      }\r\n    },\r\n\r\n    async runTopSheet() {\r\n      if (!this.files.length) return\r\n\r\n      try {\r\n        if (!this.solverThread) {\r\n          console.log('spawning topsheet thread')\r\n          this.solverThread = new TopSheetWorker()\r\n          this.solverThread.onmessage = (message: MessageEvent) => {\r\n            this.processWorkerMessage(message)\r\n          }\r\n        }\r\n\r\n        this.solverThread.postMessage({\r\n          command: 'runTopSheet',\r\n          fileSystemConfig: this.fileSystemConfig,\r\n          subfolder: this.subfolder,\r\n          files: this.files,\r\n          yaml: this.yaml,\r\n          locale: this.$store.state.locale,\r\n          allConfigFiles: this.allConfigFiles,\r\n        })\r\n      } catch (e) {\r\n        const message = '' + e\r\n        console.log(message)\r\n        this.table = []\r\n        // this.table = [{ title: message, value: '', style: { backgroundColor: 'yellow' } }]\r\n      }\r\n    },\r\n\r\n    processWorkerMessage(message: MessageEvent) {\r\n      const data = message.data\r\n      switch (data.response) {\r\n        case 'title':\r\n          if (this.cardId) this.$emit('titles', data.title)\r\n          else this.title = data.title\r\n          break\r\n        case 'entries':\r\n          this.entries = data.entryFields\r\n          break\r\n        case 'results':\r\n          this.table = data.results\r\n          this.$emit('isLoaded')\r\n          break\r\n        case 'error':\r\n          this.$store.commit('error', `${this.yaml}: ${data.message}`)\r\n          this.$emit('isLoaded')\r\n          break\r\n        default:\r\n          // shouldn't be here\r\n          this.$emit('isLoaded')\r\n          console.error(data)\r\n      }\r\n    },\r\n  },\r\n})\r\n</script>\r\n\r\n<style scoped lang=\"scss\">\r\n@import '@/styles.scss';\r\n\r\nh3.curate-heading {\r\n  font-size: 1.6rem;\r\n  font-weight: bold;\r\n  color: var(--textFancy);\r\n  padding-top: 0.5rem;\r\n  margin-top: 0rem;\r\n  margin-bottom: 0.5rem;\r\n  border-bottom: 1px dotted var(--textFancy);\r\n}\r\n\r\n.curate-content {\r\n  padding: 1rem 0rem;\r\n  margin: 0rem 0rem;\r\n}\r\n\r\n.output-table {\r\n  width: 100%;\r\n  display: table;\r\n}\r\n\r\n.row {\r\n  display: table-row;\r\n}\r\n\r\n.cell {\r\n  padding-right: 1rem;\r\n  display: table-cell;\r\n  font-size: 1.1rem;\r\n  line-height: 1.2rem;\r\n  padding-bottom: 0.4rem;\r\n}\r\n\r\n// .top-label {\r\n// }\r\n\r\n.top-value {\r\n  text-align: right;\r\n  font-weight: bold;\r\n  // word-break: break-all;\r\n}\r\n</style>\r\n","\r\n.topsheet.curate-content\r\n  h3.curate-heading(v-if=\"title\")  {{ title }}\r\n\r\n  .output-table(v-if=\"entries.length\")\r\n    .row(v-for=\"row,i in entries\" :key=\"'entry'+i\")\r\n      .cell.top-label(:style=\"row.style\") {{ row.title }}\r\n      b-input.b-input-tight.cell.top-value(\r\n        v-model=\"row.value\"\r\n        :style=\"row.style\"\r\n        @input=\"boxChanged\"\r\n      )\r\n\r\n  .output-table(v-if=\"table.length\" style=\"margin-top: 1rem\")\r\n    .row(v-for=\"row,i in table\" :key=\"'row'+i\")\r\n      .cell.top-label(:style=\"row.style\") {{ row.title }}\r\n      .cell.top-value(:style=\"row.style\") {{ formattedValue(row.value) }}\r\n\r\n"],"names":["__vue2_script","defineComponent","name","props","fileSystemConfig","type","Object","required","subfolder","String","files","Array","yaml","allConfigFiles","cardId","data","globalState","globalStore","state","solverThread","table","entries","title","mounted","this","length","runTopSheet","beforeDestroy","terminate","e","console","warn","watch","postMessage","command","locale","methods","formattedValue","value","isNaN","toLocaleString","$store","boxChanged","log","TopSheetWorker","onmessage","message","processWorkerMessage","response","$emit","entryFields","results","commit","error","_vm","_h","$createElement","_c","_self","staticClass","_v","_s","_e","_l","row","i","key","style","on","input","model","callback","$$v","$set","expression","staticStyle"],"mappings":"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"}