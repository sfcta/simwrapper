import{R as t,d as e,r as s}from"./vendor.e9c367ae.js";import{V as i}from"./vue-slider-component.umd.min.efc39df5.js";import{d as a}from"./index.e02ae17f.js";import{r}from"./index.a906c0e7.js";import{b as n}from"./index.3d2ad359.js";import{c as l}from"./index.0d83a8f9.js";import{d as o,b as h,p as c}from"./index.991028d3.js";import{n as m,g as u,R as d,M as p,L as g,C as f}from"./index.2deacc07.js";import{C as S}from"./CollapsiblePanel.58a8eae6.js";import{P as b,a as v,I as T,b as y}from"./PathTraceLayer.8ed3807c.js";import{Z as E}from"./ZoomButtons.e860a156.js";import{a as C}from"./util.b5d45f97.js";import{D as w,S as k}from"./deckgl.61194435.js";import{A as D}from"./arc-layer.bf091b3d.js";import{A as R,L as q}from"./layer.b20bd88e.js";import{H as x}from"./HTTPFileSystem.e57ad358.js";import"./index.01e94811.js";import"./index.84f8ccb6.js";import"./icon-manager.2c4c9b5c.js";import"./line-layer.600fa289.js";import"./extends.f4cf4404.js";var A=e({name:"XmasSettingsPanel",i18n:{messages:{en:{requests:"DRT&nbsp;Requests",passengers:"Passengers",search:"Search",showhide:"Show/Hide",vehicles:"DRT Vehicles",routes:"Routes",speed:"Speed",backgroundTraffic:"All Traffic"},de:{requests:"DRT&nbsp;Anfragen",passengers:"Passagiere",search:"Suche",showhide:"Ein-/Ausblenden",vehicles:"DRT Fahrzeuge",routes:"Routen",speed:"Geschwindigkeit",backgroundTraffic:"Alle Fahrzeuge"}}},components:{ToggleButton:a.exports.ToggleButton},props:{items:{type:Object,required:!0}}});const L={};var z=m(A,(function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",{staticClass:"settings-panel-content"},[s("h4",[t._v(t._s(t.$t("showhide")))]),t._l(Object.keys(t.items),(function(e){return s("div",{key:e,staticClass:"row"},[s("toggle-button",{staticClass:"toggle",attrs:{width:40,value:t.items[e],labels:!1,color:{checked:"#4b7cc4",unchecked:"#222"}},on:{change:function(s){return t.$emit("click",e)}}}),s("label",{domProps:{innerHTML:t._s(t.$t(e))}})],1)}))],2)}),[],!1,$,"3bfe1433",null,null);function $(t){for(let e in L)this[e]=L[e]}var F=function(){return z.exports}();class j extends D{getShaders(){const t=super.getShaders();return t.inject={"vs:#decl":"        attribute float timeStart;\n        attribute float timeEnd;\n        uniform float currentTime;\n        uniform float searchFlag;\n        varying float vTime;\n      ","vs:#main-start":"        if (searchFlag == 1.0) {\n          vTime = 999.0;\n        } else if (timeEnd == -1.0 || timeStart > currentTime || timeEnd < currentTime ) {\n          vTime = -1.0;\n          return;\n        } else {\n          float nearBeginning = currentTime - timeStart;\n          float nearEnd = timeEnd - currentTime;\n          vTime = min(nearBeginning, nearEnd);\n        }\n      ","fs:#decl":"        uniform float currentTime;\n        uniform float searchFlag;\n        varying float vTime;\n      ","fs:#main-start":"      if (searchFlag == 0.0 && vTime == -1.0 ) discard;\n      ","fs:DECKGL_FILTER_COLOR":"        if (vTime <= 10.0) color.a *= (vTime / 10.0);\n      "},t}initializeState(t){super.initializeState(t);this.getAttributeManager().addInstanced({timeStart:{size:1,accessor:"getTimeStart"},timeEnd:{size:1,accessor:"getTimeEnd"}})}draw(t){const{currentTime:e}=this.props;t.uniforms=Object.assign({},t.uniforms,{currentTime:e}),super.draw(t)}}j.layerName="DrtRequestArcLayer",j.defaultProps={currentTime:{type:"number",value:0,min:0},getTimeStart:{type:"accessor",value:null},getTimeEnd:{type:"accessor",value:null},searchFlag:{type:"number",value:0}};const M={marker:{x:0,y:0,width:128,height:128,mask:!0},info:{x:128,y:0,width:128,height:128,mask:!0},vehicle:{x:128,y:128,width:128,height:128,mask:!0},diamond:{x:0,y:128,width:128,height:128,mask:!1}},P={vehicleColor:[200,130,250],trailColor0:[235,235,25],trailColor1:[23,184,190],effects:[new q({ambientLight:new R({color:[255,255,255],intensity:1}),pointLight:new b({color:[255,255,255],intensity:2,position:[-74.05,40.7,8e3]})})]},I=0,V=1,_=2,H=3,O=4,N=6;const G=e({name:"VehicleAnimationPlugin",i18n:{messages:{en:{requests:"DRT Requests",passengers:"Passengers",search:"Search",showhide:"Show/Hide",vehicles:"Vehicles",routes:"Routes",speed:"Speed"},de:{requests:"DRT Anfragen",passengers:"Passagiere",search:"Suche",showhide:"Ein-/Ausblenden",vehicles:"DRT Fahrzeuge",routes:"DRT Routen",speed:"Geschwindigkeit"}}},components:{CollapsiblePanel:S,SettingsPanel:F,LegendColors:function(e){const s=e.items.map((e=>t.createElement("li",{key:e.value+e.value[0],style:{display:"flex"}},e.label&&t.createElement("div",{style:{margin:"0 0.5rem 0.0rem 0",fontWeight:"bold"}},e.label),t.createElement("div",{style:{width:"100%",height:"3px",marginTop:"0.5rem",backgroundColor:`rgb(${e.color})`}}))));return t.createElement("div",null,t.createElement("h4",{style:{textAlign:"left",fontWeight:"bold",margin:"1rem 0 0.25rem 0",fontSize:"0.8rem"}},e.title),t.createElement("p",null,e.description),t.createElement("ul",{style:{listStyle:"none",padding:0,margin:0}},s))},TripViz:function(e){const{simulationTime:i,paths:a,traces:r,drtRequests:n,settingsShowLayers:l,center:o,dark:h,vehicleLookup:c,searchEnabled:m,onClick:g,viewId:f}=e,S=P,[b,y]=s.exports.useState(o?{center:[16,42],longitude:o[0],latitude:o[1],pitch:0,bearing:0,zoom:10}:Object.assign({},u.state.viewState));d[f]=()=>{y(u.state.viewState)};const[E,C]=s.exports.useState({}),D=[];return l.routes&&D.push(new v({id:"Routen",data:r,currentTime:i,getSourcePosition:t=>t.p0,getTargetPosition:t=>t.p1,getTimeStart:t=>t.t0,getTimeEnd:t=>t.t1,getColor:t=>e.colors[t.occ],getWidth:1,opacity:.8,widthMinPixels:1,rounded:!1,shadowEnabled:!1,searchFlag:m?1:0,pickable:!0,autoHighlight:!0,highlightColor:[255,0,255],onHover:C})),l.vehicles&&D.push(new T({id:"Vehicles",data:a,getPathStart:t=>t.p0,getPathEnd:t=>t.p1,getTimeStart:t=>t.t0,getTimeEnd:t=>t.t1,getIcon:t=>"vehicle",getColor:t=>e.colors[t.occ],iconMoving:"vehicle",iconStill:"diamond",getSize:m?72:64,opacity:1,currentTime:i,shadowEnabled:!1,noAlloc:!0,iconAtlas:"/simwrapper//images/icon-atlas.png",iconMapping:M,sizeScale:.5,billboard:!1,pickable:!0,depthTest:!0,autoHighlight:!1,highlightColor:[255,0,255],onHover:C,parameters:{depthTest:!1}})),l.requests&&D.push(new j({id:"DRT Requests",data:n,currentTime:i,getSourcePosition:t=>[t[V],t[_]],getTargetPosition:t=>[t[H],t[O]],getTimeStart:t=>t[I],getTimeEnd:t=>t[N],getSourceColor:[255,0,255],getTargetColor:[200,255,255],getWidth:1,opacity:.5,searchFlag:m?1:0})),t.createElement(w,{layers:D,effects:S.effects,pickingRadius:5,viewState:b,controller:!0,getCursor:()=>"pointer",onClick:function(){console.log(E),E.object?g(E.object.v):g(null)},onViewStateChange:t=>{u.commit("setMapCamera",t.viewState)}},t.createElement(k,{mapStyle:u.getters.mapStyle,mapboxApiAccessToken:p}),function({hoverInfo:e}){const{object:s,x:i,y:a}=e;if(!s)return null;const r=c[s.v];return t.createElement("div",{className:"tooltip",style:{fontSize:"0.8rem",backgroundColor:"#ddddeedd",borderLeft:"6px solid green",boxShadow:"2.5px 2px 4px rgba(0,0,0,0.25)",color:"#223",padding:"1rem 1rem",position:"absolute",left:i+40,top:a-30}},t.createElement("big",null,t.createElement("b",null,r)),t.createElement("div",null,"Passagiere: ",s.occ," "))}({hoverInfo:E}))},VueSlider:i,PlaybackControls:y,ToggleButton:a.exports.ToggleButton,ZoomButtons:E},props:{root:{type:String,required:!0},subfolder:{type:String,required:!0},yamlConfig:String,thumbnail:Boolean},data:()=>{const t={0:[140,140,160],1:[85,255,85],2:[255,255,85],3:[240,110,30],4:[192,30,50]};return{viewId:Math.floor(1e12*Math.random()),COLOR_OCCUPANCY:t,SETTINGS:{vehicles:!0,routes:!0,requests:!1},legendItems:Object.keys(t).map((e=>({type:g.line,color:t[e],value:e,label:e}))),legendRequests:[{type:g.line,color:[255,0,255],value:0,label:""}],vizDetails:{network:"",drtTrips:"",projection:"",title:"",description:"",thumbnail:"",center:[13.45,52.5],zoom:10,mapIsIndependent:!1,theme:""},myState:{statusMessage:"",clock:"00:00",colorScheme:f.DarkMode,isRunning:!1,isShowingHelp:!1,subfolder:"",yamlConfig:"",thumbnail:!1,data:[]},timeStart:0,timeEnd:86400,traces:l([]),traceStart:{},traceEnd:{},traceVehicle:{},paths:l([]),pathStart:{},pathEnd:{},pathVehicle:{},requests:l([]),requestStart:{},requestEnd:{},requestVehicle:{},simulationTime:21600,timeElapsedSinceLastFrame:0,searchTerm:"",searchEnabled:!1,globalState:u.state,isDarkMode:u.state.isDarkMode,isLoaded:!0,showHelp:!1,speedStops:[-10,-5,-2,-1,-.5,-.25,0,.25,.5,1,2,5,10],speed:1,legendBits:[],thumbnailUrl:"url('assets/thumbnail.jpg') no-repeat;",vehicleLookup:[],vehicleLookupString:{},isPausedDueToHiding:!1}},computed:{fileApi(){return new x(this.fileSystem,u)},fileSystem(){const t=this.$store.state.svnProjects.filter((t=>t.slug===this.root));if(0===t.length)throw console.log("no such project"),Error;return t[0]},urlThumbnail(){return this.thumbnailUrl},textColor(){return this.myState.colorScheme===f.DarkMode?{text:"white",bg:"#181518aa"}:{text:"#3498db",bg:"#eeeef480"}}},watch:{"$store.state.viewState"(){this.vizDetails.mapIsIndependent||d[this.viewId]&&d[this.viewId]()},async"globalState.authAttempts"(){console.log("AUTH CHANGED - Reload"),this.yamlConfig||this.buildRouteFromUrl(),await this.getVizDetails()},"globalState.colorScheme"(){this.isDarkMode=this.globalState.colorScheme===f.DarkMode,this.updateLegendColors()},searchTerm(){var t,e,s,i,a,r;const n=this.vehicleLookupString[this.searchTerm];n>-1?(console.log("vehicle",n),null==(t=this.pathVehicle)||t.filterExact(n),null==(e=this.traceVehicle)||e.filterExact(n),null==(s=this.requestVehicle)||s.filterExact(n),this.requestStart.filterAll(),this.requestEnd.filterAll(),this.searchEnabled=!0):(console.log("nope"),null==(i=this.pathVehicle)||i.filterAll(),null==(a=this.traceVehicle)||a.filterAll(),null==(r=this.requestVehicle)||r.filterAll(),this.searchEnabled=!1),this.updateDatasetFilters()}},methods:{async handleSettingChange(t){console.log(t),this.SETTINGS[t]=!this.SETTINGS[t],this.updateDatasetFilters(),this.simulationTime+=1},buildRouteFromUrl(){const t=this.$route.params;if(!t.project||!t.pathMatch)return void console.log("I CANT EVEN: NO PROJECT/PARHMATCH");const e=1+t.pathMatch.lastIndexOf("/"),s=t.pathMatch.substring(0,e),i=t.pathMatch.substring(e);this.myState.subfolder=s,this.myState.yamlConfig=i},async getVizDetails(){try{const t=this.myState.yamlConfig.indexOf("/")>-1?this.myState.yamlConfig:this.myState.subfolder+"/"+this.myState.yamlConfig,e=await this.fileApi.getFileText(t);this.vizDetails=n.parse(e)}catch(e){console.log("failed");const t=e;this.fileSystem.needPassword&&401===t.status&&u.commit("requestLogin",this.fileSystem.slug)}this.vizDetails.theme&&this.$store.commit("setTheme",this.vizDetails.theme),this.vizDetails.center&&this.$store.commit("setMapCamera",{longitude:this.vizDetails.center[0],latitude:this.vizDetails.center[1],zoom:this.vizDetails.zoom||10,pitch:10,bearing:0});const t=this.vizDetails.title?this.vizDetails.title:"Agent Animation";this.$emit("title",t),this.buildThumbnail()},async buildThumbnail(){if(this.thumbnail&&this.vizDetails.thumbnail)try{const t=await this.fileApi.getFileBlob(this.myState.subfolder+"/"+this.vizDetails.thumbnail),e=await r.arraybuffer(t),s=C(e);s&&(this.thumbnailUrl=`center / cover no-repeat url(data:image/png;base64,${s})`)}catch(t){console.error(t)}},handleClick(t){if(null===t)return void(this.searchTerm="");const e=this.vehicleLookup[t];console.log(e),this.searchTerm===e?this.searchTerm="":this.searchTerm=e},updateLegendColors(){},setWallClock(){const t=Math.floor(this.simulationTime/3600),e=Math.floor(this.simulationTime/60)%60;this.myState.clock=`${t<10?"0":""}${t}${e<10?":0":":"}${e}`},setTime(t){this.simulationTime=t,this.setWallClock(),this.traceStart&&this.pathStart&&this.requestStart&&(this.pathStart.filter([0,this.simulationTime]),this.pathEnd.filter([this.simulationTime,1/0]),this.searchEnabled||(this.traceStart.filter([0,this.simulationTime]),this.traceEnd.filter([this.simulationTime,1/0]),this.requestStart.filter([0,this.simulationTime]),this.requestEnd.filter([this.simulationTime,1/0]))),this.$options.paths=this.paths.allFiltered(),this.$options.traces=this.traces.allFiltered(),this.$options.drtRequests=this.requests.allFiltered()},toggleSimulation(){this.myState.isRunning=!this.myState.isRunning,this.timeElapsedSinceLastFrame=Date.now(),this.myState.isRunning&&0===this.speed&&(this.speed=1),this.myState.isRunning&&this.animate()},async parseDrtRequests(t){if(this.vehicleLookup.length)for(const s of t)try{s[5]=this.vehicleLookupString[s[5]]}catch(e){}return l(t)},async parseVehicles(t){const e=[];let s=-1;return await o.forEachAsync(t,(t=>{const i=t.path,a=t.timestamps,r=t.passengers;s++,this.vehicleLookup[s]=t.id,this.vehicleLookupString[t.id]=s;for(let n=0;n<t.path.length-1;n++)e.push({t0:a[n],t1:a[n+1],p0:i[n],p1:i[n+1],v:s,occ:r[n]})})),l(e)},updateDatasetFilters(){this.traceStart&&this.pathStart&&this.requestStart&&(this.SETTINGS.routes&&(this.searchEnabled?(this.traceStart.filterAll(),this.traceEnd.filterAll()):(this.traceStart.filter([0,this.simulationTime]),this.traceEnd.filter([this.simulationTime,1/0])),this.$options.traces=this.traces.allFiltered()),this.SETTINGS.vehicles&&(this.pathStart.filter([0,this.simulationTime]),this.pathEnd.filter([this.simulationTime,1/0]),this.$options.paths=this.paths.allFiltered()),this.SETTINGS.requests&&(this.searchEnabled?(this.requestStart.filterAll(),this.requestEnd.filterAll()):(this.requestStart.filter([0,this.simulationTime]),this.requestEnd.filter([this.simulationTime,1/0])),this.$options.drtRequests=this.requests.allFiltered()))},animate(){if(this.myState.isRunning){const t=Date.now()-this.timeElapsedSinceLastFrame;this.timeElapsedSinceLastFrame+=t,this.simulationTime+=t*this.speed*.06,this.updateDatasetFilters(),this.setWallClock(),window.requestAnimationFrame(this.animate)}},handleVisibilityChange(){this.isPausedDueToHiding&&!document.hidden?(console.log("unpausing"),this.isPausedDueToHiding=!1,this.toggleSimulation()):this.myState.isRunning&&document.hidden&&(console.log("pausing"),this.isPausedDueToHiding=!0,this.toggleSimulation())},async parseRouteTraces(t){let e=-1;const s=[];return await o.forEachAsync(t,(t=>{e++;let i=t.timestamps[0],a=t.timestamps[0],r=[];for(let n=1;n<t.path.length;n++)a=t.timestamps[n],t.path[n][0]===t.path[n-1][0]&&t.path[n][1]===t.path[n-1][1]?(r.forEach((e=>{e.t1=t.timestamps[n-1]})),s.push(...r),r=[],i=a):r.push({t0:i,p0:t.path[n-1],p1:t.path[n],v:e,occ:t.passengers[n-1]});r.forEach((t=>{t.t1=a})),s.push(...r)})),l(s)},async loadFiles(){let t=[],e=[];try{if(this.vizDetails.drtTrips.endsWith("json")){const s=await this.fileApi.getFileJson(this.myState.subfolder+"/"+this.vizDetails.drtTrips);t=s.trips,e=s.drtRequests}else if(this.vizDetails.drtTrips.endsWith("gz")){const s=await this.fileApi.getFileBlob(this.myState.subfolder+"/"+this.vizDetails.drtTrips),i=s?await h(s):null;let a=await o.run(c.inflateAsync(i,{to:"string"}));const r=JSON.parse(a);t=r.trips,e=r.drtRequests}}catch(s){console.error(s),this.myState.statusMessage=""+s}return{trips:t,drtRequests:e}},toggleLoaded(t){this.isLoaded=t},rotateColors(){this.myState.colorScheme=this.myState.colorScheme===f.DarkMode?f.LightMode:f.DarkMode,localStorage.setItem("plugin/agent-animation/colorscheme",this.myState.colorScheme)}},async mounted(){var t;if(u.commit("setFullScreen",!this.thumbnail),this.myState.thumbnail=this.thumbnail,this.myState.yamlConfig=null!=(t=this.yamlConfig)?t:"",this.myState.subfolder=this.subfolder,await this.getVizDetails(),this.thumbnail)return;this.showHelp=!1,this.updateLegendColors(),this.setWallClock(),this.myState.statusMessage="/ Dateien laden...",console.log("loading files");const{trips:e,drtRequests:s}=await this.loadFiles();console.log("parsing vehicle motion"),this.myState.statusMessage=`${this.$t("vehicles")}...`,this.paths=await this.parseVehicles(e),this.pathStart=this.paths.dimension((t=>t.t0)),this.pathEnd=this.paths.dimension((t=>t.t1)),this.pathVehicle=this.paths.dimension((t=>t.v)),console.log("Routes..."),this.myState.statusMessage=`${this.$t("routes")}...`,this.traces=await this.parseRouteTraces(e),this.traceStart=this.traces.dimension((t=>t.t0)),this.traceEnd=this.traces.dimension((t=>t.t1)),this.traceVehicle=this.traces.dimension((t=>t.v)),console.log("Requests..."),this.myState.statusMessage=`${this.$t("requests")}...`,this.requests=await this.parseDrtRequests(s),this.requestStart=this.requests.dimension((t=>t[0])),this.requestEnd=this.requests.dimension((t=>t[6])),this.requestVehicle=this.requests.dimension((t=>t[5])),console.log("GO!"),this.myState.statusMessage="",document.addEventListener("visibilitychange",this.handleVisibilityChange,!1),this.myState.isRunning=!0,this.timeElapsedSinceLastFrame=Date.now(),this.animate()},beforeDestroy(){document.removeEventListener("visibilityChange",this.handleVisibilityChange),u.commit("setFullScreen",!1),this.$store.commit("setFullScreen",!1),this.myState.isRunning=!1}});const B={};var W=m(G,(function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",{staticClass:"gl-app",class:{"hide-thumbnail":!t.thumbnail},style:{background:t.urlThumbnail},attrs:{oncontextmenu:"return false"}},[t.thumbnail?t._e():s("trip-viz",{staticClass:"anim",attrs:{center:t.vizDetails.center,colors:t.COLOR_OCCUPANCY,drtRequests:t.$options.drtRequests,dark:t.globalState.isDarkMode,paths:t.$options.paths,settingsShowLayers:t.SETTINGS,searchEnabled:t.searchEnabled,simulationTime:t.simulationTime,traces:t.$options.traces,vehicleLookup:t.vehicleLookup,viewId:t.viewId,onClick:t.handleClick}}),t.thumbnail?t._e():s("zoom-buttons"),t.isLoaded&&!t.thumbnail?s("div",{staticClass:"right-side"},[s("collapsible-panel",{attrs:{direction:"right"}},[s("div",{staticClass:"big clock"},[s("p",[t._v(t._s(t.myState.clock))])]),s("div",{staticClass:"panel-items"},[t.legendItems.length?s("legend-colors",{staticClass:"legend-block",attrs:{title:`${t.$t("passengers")}:`,items:t.legendItems}}):t._e(),s("legend-colors",{staticClass:"legend-block",attrs:{title:`${t.$t("requests")}:`,items:t.legendRequests}}),s("div",{staticClass:"search-panel"},[s("p",{staticClass:"speed-label",style:{margin:"1rem 0 0 0"}},[t._v(t._s(t.$t("search")))]),s("form",{attrs:{autocomplete:"off"}}),s("div",{staticClass:"field"},[s("p",{staticClass:"control has-icons-left"},[s("input",{directives:[{name:"model",rawName:"v-model",value:t.searchTerm,expression:"searchTerm"}],staticClass:"input is-small",attrs:{type:"email",placeholder:`${t.$t("search")}...`},domProps:{value:t.searchTerm},on:{input:function(e){e.target.composing||(t.searchTerm=e.target.value)}}}),s("span",{staticClass:"icon is-small is-left"},[s("i",{staticClass:"fas fa-search"})])])])]),s("settings-panel",{staticClass:"settings-area",attrs:{items:t.SETTINGS},on:{click:t.handleSettingChange}}),s("div",{staticClass:"speed-block"},[s("p",{staticClass:"speed-label"},[t._v(t._s(t.$t("speed"))+":"),s("br"),t._v(t._s(t.speed)+"x")]),s("b-slider",{staticClass:"speed-slider",attrs:{min:t.speedStops[0],max:t.speedStops[t.speedStops.length-1],duration:0,dotSize:20,tooltip:!0,"tooltip-placement":"bottom","tooltip-formatter":function(t){return t+"x"}},model:{value:t.speed,callback:function(e){t.speed=e},expression:"speed"}},[t._l(t.speedStops,(function(t){return[s("b-slider-tick",{key:t,attrs:{value:t}})]}))],2)],1)],1)])],1):t._e(),!t.thumbnail&&t.isLoaded?s("playback-controls",{staticClass:"bottom-area",attrs:{timeStart:t.timeStart,timeEnd:t.timeEnd,isRunning:t.myState.isRunning,currentTime:t.simulationTime},on:{click:t.toggleSimulation,time:t.setTime}}):t._e()],1)}),[],!1,U,"3a49c3c3",null,null);function U(t){for(let e in B)this[e]=B[e]}var J=function(){return W.exports}();export{J as default};
//# sourceMappingURL=VehicleAnimation.5ea69f43.js.map
